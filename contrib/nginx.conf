# Sample nginx configuration for FlightRadar SSE endpoints
# This configuration ensures SSE (Server-Sent Events) streams are not buffered

server {
    server_name your-domain.com;

    # SSE streams - MUST come before the general location block
    # This matches both /api/v1/positions/live/stream and /api/v1/flights/{id}/positions/stream
    location ~ ^/api/v1/(positions/live/stream|flights/.*/positions/stream)$ {
        proxy_pass              http://127.0.0.1:5001;
        proxy_http_version      1.1;

        # Critical for SSE - disable ALL buffering
        proxy_buffering         off;
        proxy_cache             off;
        proxy_set_header        Connection '';
        chunked_transfer_encoding off;

        # Headers
        proxy_set_header        Host                 $host;
        proxy_set_header        X-Real-IP            $remote_addr;
        proxy_set_header        X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto    $scheme;

        # Timeouts for long-lived connections
        proxy_read_timeout      3600s;
        proxy_send_timeout      3600s;
        proxy_connect_timeout   60s;
    }

    # General API endpoints
    location / {
        proxy_pass              http://127.0.0.1:5001/;
        proxy_redirect          off;

        proxy_set_header        Host                 $host;
        proxy_set_header        X-Real-IP            $remote_addr;
        proxy_set_header        X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto    $scheme;
    }

    # SSL configuration - customize with your certificates
    listen 443 ssl;
    listen [::]:443 ssl;

    # ssl_certificate /path/to/fullchain.pem;
    # ssl_certificate_key /path/to/privkey.pem;
    # ssl_dhparam /path/to/ssl-dhparams.pem;
}

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com;
    return 301 https://$host$request_uri;
}
